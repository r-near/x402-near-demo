name: x402 Demo

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  demo:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Create .env
        run: |
          cat > .env << EOF
          NEAR_NETWORK=testnet
          NEAR_RPC=https://rpc.testnet.fastnear.com
          TOKEN_ACCOUNT_ID=3e2210e1184b45b64c8a434c0a7e7b23cc04ea7eb7a6c3c32520d03d4afcb8af
          SELLER_ACCOUNT_ID=x402-seller.testnet
          RELAYER_ACCOUNT_ID=x402-relayer.testnet
          RELAYER_PRIVATE_KEY=${{ secrets.RELAYER_PRIVATE_KEY }}
          PRICE_ATOMIC=10000
          SELLER_PORT=4021
          FACILITATOR_PORT=4022
          BUYER_ACCOUNT_ID=x402-buyer.testnet
          BUYER_PRIVATE_KEY=${{ secrets.BUYER_PRIVATE_KEY }}
          EOF

      - name: Start facilitator
        run: bun run facilitator &
        env:
          FORCE_COLOR: "3"

      - name: Start seller
        run: bun run seller &
        env:
          FORCE_COLOR: "3"

      - name: Wait for services
        run: sleep 3

      - name: Run buyer demo
        run: bun run buyer
        env:
          FORCE_COLOR: "3"
